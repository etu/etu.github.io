<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head>
    <title>The day when ZFS saved my data - Elis Hirwing</title>

    
    <meta charset="utf-8">

    
    <meta name="referrer" content="no-referrer">

    
    <link rel="canonical" href="https://elis.nu/blog/2021/05/the-day-when-zfs-saved-my-data/">

    
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    

    
    
        <link rel="icon" type="image/png" href="https://elis.nu/img/elis.webp">
    

    
    <meta property="description" content="">

    
    <meta property="og:description" content="">
    <meta property="og:locale" content="en">
    <meta property="og:site_name" content="Elis Hirwing">
    <meta property="og:title" content="The day when ZFS saved my data &middot; Elis Hirwing">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://elis.nu/blog/2021/05/the-day-when-zfs-saved-my-data/">
    
    <meta name="twitter:card" content="summary_large_image">

    
    <link rel="me" href="https://chaos.social/@sa0bse">

<style>
  aside#advert {
    max-width: 48rem;
    margin: 2rem auto 0 auto;
  }
  aside#advert a {
    background: #26101b;
    color: #d58bcc;
    display: block;
    text-decoration: none;
    margin: 0 4rem 2rem 4rem;
    padding: 2rem 1.5rem 1.5rem 1.5rem;
    text-align: center;
    border-radius: .25rem;
    border: .1rem solid #a6a6a6;
  }
  aside#advert a::after {
    content: 'Ad';
    font-size: .75rem;
    background-image: none;
    position: absolute;
    top: 0;
    left: 0;
    width: fit-content;
    height: fit-content;
    padding: .4rem .6rem;
    margin-left: 0;
    background-color: #4a2739;
    color: #e6c0e1;
    border-radius: .25rem 0;
  }
  html body header div.i18n {
    /* Ensure the i18n menu is above the aside advert in the header */
    z-index: 2 !important;
  }
</style>

<!-- Matomo -->
<script>
  var _paq = window._paq = window._paq || [];
  /* tracker methods like "setCustomDimension"
     should be called before "trackPageView" */
  _paq.push(['disableCookies']);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//matomo.taserud.net/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '3']);
    var d=document,
        g=d.createElement('script'),
        s=d.getElementsByTagName('script')[0];
    g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->

    
    
        
        
            
                
                <link rel="stylesheet" href="/css/style.min.25f74453793d863e9c479d5f0be6eb3aa22d76f70bcfa8cbbb784784c7cfc4b4.css" integrity="sha256-JfdEU3k9hj6cR51fC&#43;brOqItdvcLz6jLu3hHhMfPxLQ=" crossorigin="anonymous" media="screen">
                
            
        
    
</head>

    <body><header>
    
        <div class="i18n">
            <ul>
                
                    <li>
                        <a href="/sv/">
                            <img src="/img/iso-flags/se.svg" alt="se flag">
                        </a>
                    </li>
                
            </ul>
        </div>
    
    
    
    <aside id="advert">
  <a href="https://taserud.net/en/?mtm_campaign=ElisNuTopBanner"
    target="_blank">
    Are you looking for IT consultancy services in the NixOS, Linux,
    Kubernetes, DevOps space? Check out <u>Taserud Consulting AB</u>.
  </a>
</aside>
    <nav>
        
            <ul>
                

                
                    <li><a href="/">~elis/</a></li>
                
                    <li><a href="/about/">./about/</a></li>
                
                    <li><a href="/work/">./work/</a></li>
                
                    <li><a href="/talks/">./talks/</a></li>
                
                    <li><a href="/blog/">./blog/</a></li>
                
                    <li><a href="/3d-models/">./3d-models/</a></li>
                
            </ul>
        
    </nav>
</header>
<div class="wrapper">
<div class="content">
    
        <h1>The day when ZFS saved my data</h1>
    <span class="post-meta">
    2021-05-21

    
        &middot; 5 minutes read
    

    
        &middot;
        
            <a class="tag" href="/tags/nixos/">NixOS</a>
        
            <a class="tag" href="/tags/zfs/">ZFS</a>
        
            <a class="tag" href="/tags/linux/">Linux</a>
        
            <a class="tag" href="/tags/backup/">Backup</a>
        
    
</span>
<p>Today my work day didn&rsquo;t turn out the way I expected. It started like a
normal day, I woke up around the regular time, did my morning routine, sat at
my desk and started my work-issued laptop.</p>
<p>It booted up just fine, I connected it to my Ultrawide display, started going
through Slack and Email and catch up on some news while drinking my morning
tea and waking up.</p>
<p>Then after around an hour of work things started to hang up, most notably
Firefox totally froze up. I could launch a new terminal but not start <code>htop</code>,
I had a <code>htop</code> session in a terminal already because it&rsquo;s part of what I
usually have running. So I went there to look.</p>
<p>In my <code>htop</code> I had ever increasing load increasing with more than <code>1.0</code> in
load per second but nothing actually using any resources for real. Something
was definitely bad, probably with disk access. I tried to run <code>ls</code>, and it
just locked up.</p>
<p>Then I rebooted my laptop, started it up, the EFI took ages to show up and to
pass through to <code>systemd-boot</code>, but it eventually did, so the disk wasn&rsquo;t
fully dead. Then I went on to boot my system and the ZFS pool wouldn&rsquo;t import
and it said something along the lines that recovery would be possible but
that I would lose data.</p>
<p>This was the point where it got to me how bad it was.</p>
<h2 id="looking-up-how-bad-it-was">Looking up how bad it was</h2>
<p>So I took my personal laptop, set up a NixOS to create a NixOS live USB stick
since that supports ZFS. Booted it up. I could indeed import the ZFS pool. I
then scrubbed the pool to confirm how bad it was.</p>
<p>This was the output from <code>zpool status -v</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl">[root@nixos:/home/nixos]# zpool status -v
</span></span><span class="line"><span class="cl">  pool: zroot
</span></span><span class="line"><span class="cl"> state: DEGRADED
</span></span><span class="line"><span class="cl">status: One or more devices has experienced an error resulting in data
</span></span><span class="line"><span class="cl">        corruption.  Applications may be affected.
</span></span><span class="line"><span class="cl">action: Restore the file in question if possible. Otherwise restore the
</span></span><span class="line"><span class="cl">        entire pool from backup.
</span></span><span class="line"><span class="cl">   see: https://openzfs.github.io/openzfs-docs/msg/ZFS-8000-8A
</span></span><span class="line"><span class="cl">  scan: scrub in progress since Fri May 21 07:20:10 2021
</span></span><span class="line"><span class="cl">        131G scanned at 649M/s, 70.2G issued at 347M/s, 143G total
</span></span><span class="line"><span class="cl">        180K repaired, 49.18% done, 00:03:33 to go
</span></span><span class="line"><span class="cl">config:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        NAME                                                     STATE      READ WRITE CKSUM
</span></span><span class="line"><span class="cl">        zroot                                                    DEGRADED      0     0     0
</span></span><span class="line"><span class="cl">          nvme-LENSE30256GMSP34MEAT3TA_FBBS19071030004166-part1  DEGRADED    206     0    96  too many errors  (reparing)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">errors: Permanent errors have been detected in the following files:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        zroot/nix:&lt;0x0&gt;
</span></span><span class="line"><span class="cl">        zroot/home@zfs-auto-snap_frequent-2021-05-21-08h15:&lt;0x0&gt;
</span></span><span class="line"><span class="cl">        zroot/home@zfs-auto-snap_frequent-2021-05-21-08h15:/etu/.mozilla/firefox/&lt;redacted&gt;
</span></span><span class="line"><span class="cl">        zroot/home:&lt;0x0&gt;
</span></span><span class="line"><span class="cl">        zroot/home:/etu/.mozilla/firefox/&lt;redacted&gt;
</span></span><span class="line"><span class="cl">        zroot/home:/etu/.mozilla/firefox/&lt;redacted&gt;
</span></span><span class="line"><span class="cl">        zroot/home:/etu/.mozilla/firefox/&lt;redacted&gt;
</span></span></code></pre></div><p>While doing this scrub I had my kernel spamming messages like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-plain" data-lang="plain"><span class="line"><span class="cl">[ 358.895359] blk_update_request: critical medium error, dev nvme0n1, sector
</span></span><span class="line"><span class="cl">              279163624 op 0x0:(READ) flags 0x0 phys_seg 11 prio class 0
</span></span></code></pre></div><h2 id="starting-to-recover">Starting to recover</h2>
<p>So obviously some of my Firefox state was damaged, no big deal, but my
snapshot created at 08:00 this morning was intact it seemed. So I managed to
do a ZFS send to back this snapshot up to my file server at home.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">zfs send zroot/home@zfs-auto-snap_frequent-2021-05-21-08h00 <span class="p">|</span> pv <span class="p">|</span>
</span></span><span class="line"><span class="cl">    ssh my-user@my-home-server <span class="s1">&#39;cat &gt; backups/work/home-filesystem.zfs&#39;</span>
</span></span></code></pre></div><p>This took a while because it was 25G worth of data. Most of which is &ldquo;backed
up&rdquo; in terms of repositories on GitHub or in form of database dumps that I
can do again. Then I would lose all my shell history and some miscellaneous
files that were in neither of these places. I also didn&rsquo;t want to sort all of
these things out from scratch.</p>
<p>The transfer of this snapshot was successful.</p>
<h2 id="setting-up-a-work-environment">Setting up a work environment</h2>
<p>As a temporary measure I&rsquo;ve imported my work NixOS modules on my private
laptop, then I got all utilities and tools needed to do my job. Sure still
needed some passwords and SSH-keys, but passwords I could get from the
password manager and SSH-keys could be added. So no biggie there.</p>
<p>Then I imported the ZFS snapshot that I&rsquo;ve managed to recover from the work
laptop onto a new ZFS filesystem in the ZFS pool on my private laptop and
changed my private laptops NixOS configuration to mount the work home folder
instead of the regular one.</p>
<p>A NixOS rebuild later and I was back in business except that I needed to
rebuild some docker containers and such.</p>
<h2 id="takeaways-from-today">Takeaways from today</h2>
<p>I need a real and proper backup strategy, I was damn aware that I didn&rsquo;t have
one and I was sure about that I wouldn&rsquo;t be as scared or sad if this sort of
thing would happen since &ldquo;most things are in git anyways&rdquo;.</p>
<p>This has proved to me that I need to set this up as soon as possible.</p>
<p>I was lucky that I had ZFS telling me so clearly what was wrong, how it was
wrong, what I could recover, what I couldn&rsquo;t recover so when I did recover my
data I&rsquo;m sure that I managed to recover every single bit of data that I cared
about backing up. If it wasn&rsquo;t for ZFS I&rsquo;m not sure that I would have noticed
as early as I did and I&rsquo;m not sure that I would have been able to save any of
the data.</p>
<p>Snapshots on the machine you use isn&rsquo;t a replacement for backups, but it&rsquo;s a
really good tool for creating backups based on.</p>

</div>

        </div><footer class="footer">
    <div class="content">
        
            <p>
                Copyright &copy; 2010 Elis Hirwing
            </p>
        
        <p>
            Made with <i class="fa-solid fa-heart" style="color: red"></i> in Arvika
            by <a href="https://taserud.net/en/?mtm_campaign=ThemeAlbatrossFooter&mtm_kwd=https%2f%2felis.nu%2f" target="_blank">Taserud Consulting AB</a>.
        </p>
    </div>
</footer>

    </body>
</html>
